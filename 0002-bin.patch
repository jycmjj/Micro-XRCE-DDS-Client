From 9af7f8ef9cacf6f73d73dbcfd81250e6dbf881c6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E8=82=96=E7=BE=8E=E7=A5=A5240108?= <2922073250@xiaomi.com>
Date: Tue, 4 Jun 2024 19:09:07 +0800
Subject: [PATCH] bin

---
 CMakeLists.txt                            |   1 +
 examples/PublishBinStudent/CMakeLists.txt |  49 +++++++++
 examples/PublishBinStudent/Student.c      |  63 +++++++++++
 examples/PublishBinStudent/Student.h      |  57 ++++++++++
 examples/PublishBinStudent/Student.idl    |   5 +
 examples/PublishBinStudent/main.c         | 125 ++++++++++++++++++++++
 6 files changed, 300 insertions(+)
 create mode 100644 examples/PublishBinStudent/CMakeLists.txt
 create mode 100644 examples/PublishBinStudent/Student.c
 create mode 100644 examples/PublishBinStudent/Student.h
 create mode 100644 examples/PublishBinStudent/Student.idl
 create mode 100644 examples/PublishBinStudent/main.c

diff --git a/CMakeLists.txt b/CMakeLists.txt
index cdb7e6e..25b969f 100755
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -404,6 +404,7 @@ if(UCLIENT_BUILD_EXAMPLES)
     add_subdirectory(examples/Deployment)
     add_subdirectory(examples/Discovery)
     add_subdirectory(examples/MultiSessionHelloWorld)
+    add_subdirectory(examples/PublishBinStudent)
     add_subdirectory(examples/PublishHelloWorld)
     add_subdirectory(examples/PublishHelloWorldP2P)
     add_subdirectory(examples/PublishStudent)
diff --git a/examples/PublishBinStudent/CMakeLists.txt b/examples/PublishBinStudent/CMakeLists.txt
new file mode 100644
index 0000000..c2676a9
--- /dev/null
+++ b/examples/PublishBinStudent/CMakeLists.txt
@@ -0,0 +1,49 @@
+# Copyright 2017 Proyectos y Sistemas de Mantenimiento SL (eProsima).
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+cmake_minimum_required(VERSION 2.8.12)
+if (${CMAKE_VERSION} VERSION_GREATER 3.0)
+    cmake_policy(SET CMP0048 NEW)
+endif()
+
+project(PublishBinStudentClient C)
+
+if(NOT UCLIENT_BUILD_EXAMPLES)
+    find_package(microxrcedds_client REQUIRED)
+endif()
+
+if(NOT UCLIENT_PROFILE_UDP)
+    message(WARNING "Can not compile example: The UCLIENT_PROFILE_UDP must be enabled.")
+else()
+    add_executable(${PROJECT_NAME} main.c Student.c)
+    if(MSVC OR MSVC_IDE)
+        target_compile_options(${PROJECT_NAME} PRIVATE /wd4996)
+    endif()
+
+    set_target_properties(${PROJECT_NAME} PROPERTIES
+        C_STANDARD 99
+        C_STANDARD_REQUIRED YES
+        )
+
+    target_link_libraries(${PROJECT_NAME} microxrcedds_client $<$<C_COMPILER_ID:GNU>:-Wl,--gc-section,--no-export-dynamic>)
+
+    if(UCLIENT_INSTALL_EXAMPLES)
+        install(
+            TARGETS
+                ${PROJECT_NAME}
+            RUNTIME DESTINATION
+                ${BIN_INSTALL_DIR}
+            )
+    endif()
+endif()
diff --git a/examples/PublishBinStudent/Student.c b/examples/PublishBinStudent/Student.c
new file mode 100644
index 0000000..0ca1ed8
--- /dev/null
+++ b/examples/PublishBinStudent/Student.c
@@ -0,0 +1,63 @@
+// Copyright 2016 Proyectos y Sistemas de Mantenimiento SL (eProsima).
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//     http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+/*!
+ * @file Student.c
+ * This source file contains the definition of the described types in the IDL file.
+ *
+ * This file was generated by the tool gen.
+ */
+
+#include "Student.h"
+
+#include <ucdr/microcdr.h>
+#include <string.h>
+
+bool Student_serialize_topic(ucdrBuffer* writer, const Student* topic)
+{
+    bool success = true;
+
+        success &= ucdr_serialize_string(writer, topic->name);
+
+        success &= ucdr_serialize_int32_t(writer, topic->id);
+
+        success &= ucdr_serialize_string(writer, topic->birthday);
+
+    return success && !writer->error;
+}
+
+bool Student_deserialize_topic(ucdrBuffer* reader, Student* topic)
+{
+    bool success = true;
+
+        success &= ucdr_deserialize_string(reader, topic->name, 255);
+
+        success &= ucdr_deserialize_int32_t(reader, &topic->id);
+
+        success &= ucdr_deserialize_string(reader, topic->birthday, 255);
+
+    return success && !reader->error;
+}
+
+uint32_t Student_size_of_topic(const Student* topic, uint32_t size)
+{
+    uint32_t previousSize = size;
+        size += ucdr_alignment(size, 4) + 4 + (uint32_t)strlen(topic->name) + 1;
+
+        size += ucdr_alignment(size, 4) + 4;
+
+        size += ucdr_alignment(size, 4) + 4 + (uint32_t)strlen(topic->birthday) + 1;
+
+    return size - previousSize;
+}
diff --git a/examples/PublishBinStudent/Student.h b/examples/PublishBinStudent/Student.h
new file mode 100644
index 0000000..e405d46
--- /dev/null
+++ b/examples/PublishBinStudent/Student.h
@@ -0,0 +1,57 @@
+// Copyright 2016 Proyectos y Sistemas de Mantenimiento SL (eProsima).
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//     http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+/*!
+ * @file Student.h
+ * This header file contains the declaration of the described types in the IDL file.
+ *
+ * This file was generated by the tool gen.
+ */
+
+#ifndef _Student_H_
+#define _Student_H_
+
+#ifdef __cplusplus
+extern "C"
+{
+#endif
+
+#include <stdint.h>
+#include <stdbool.h>
+
+/*!
+ * @brief This struct represents the structure Student defined by the user in the IDL file.
+ * @ingroup Student
+ */
+typedef struct Student
+{
+    char name[255];
+
+    int32_t id;
+    char birthday[255];
+
+} Student;
+
+struct ucdrBuffer;
+
+bool Student_serialize_topic(struct ucdrBuffer* writer, const Student* topic);
+bool Student_deserialize_topic(struct ucdrBuffer* reader, Student* topic);
+uint32_t Student_size_of_topic(const Student* topic, uint32_t size);
+
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif // _Student_H_
\ No newline at end of file
diff --git a/examples/PublishBinStudent/Student.idl b/examples/PublishBinStudent/Student.idl
new file mode 100644
index 0000000..f88519b
--- /dev/null
+++ b/examples/PublishBinStudent/Student.idl
@@ -0,0 +1,5 @@
+struct Student {
+    string name ;  
+    long id;
+    string birthday;            
+};
diff --git a/examples/PublishBinStudent/main.c b/examples/PublishBinStudent/main.c
new file mode 100644
index 0000000..4bea03b
--- /dev/null
+++ b/examples/PublishBinStudent/main.c
@@ -0,0 +1,125 @@
+// Copyright 2017 Proyectos y Sistemas de Mantenimiento SL (eProsima).
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//     http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+#include "Student.h"
+
+#include <uxr/client/client.h>
+#include <ucdr/microcdr.h>
+
+#include <stdio.h> //printf
+#include <string.h> //strcmp
+#include <stdlib.h> //atoi
+
+#define STREAM_HISTORY  8
+#define BUFFER_SIZE     UXR_CONFIG_UDP_TRANSPORT_MTU* STREAM_HISTORY
+
+int main(
+        int args,
+        char** argv)
+{
+    // CLI
+    if (3 > args || 0 == atoi(argv[2]))
+    {
+        printf("usage: program [-h | --help] | ip port [<max_topics>]\n");
+        return 0;
+    }
+
+    char* ip = argv[1];
+    char* port = argv[2];
+    uint32_t max_topics = (args == 4) ? (uint32_t)atoi(argv[3]) : UINT32_MAX;
+
+    // Transport
+    uxrUDPTransport transport;
+    if (!uxr_init_udp_transport(&transport, UXR_IPv4, ip, port))
+    {
+        printf("Error at create transport.\n");
+        return 1;
+    }
+
+    // Session
+    uxrSession session;
+    uxr_init_session(&session, &transport.comm, 0xAAAABBBB);
+    if (!uxr_create_session(&session))
+    {
+        printf("Error at create session.\n");
+        return 1;
+    }
+
+    // Streams
+    uint8_t output_reliable_stream_buffer[BUFFER_SIZE];
+    uxrStreamId reliable_out = uxr_create_output_reliable_stream(&session, output_reliable_stream_buffer, BUFFER_SIZE,
+                    STREAM_HISTORY);
+
+    uint8_t input_reliable_stream_buffer[BUFFER_SIZE];
+    uxr_create_input_reliable_stream(&session, input_reliable_stream_buffer, BUFFER_SIZE, STREAM_HISTORY);
+
+    // Create entities
+   uxrObjectId participant_id = uxr_object_id(0x01, UXR_PARTICIPANT_ID);
+    uint16_t participant_req =
+            uxr_buffer_create_participant_bin(&session, reliable_out, participant_id, 0, "default_xrce_participant",
+                    UXR_REPLACE);
+
+    uxrObjectId topic_id = uxr_object_id(0x01, UXR_TOPIC_ID);
+    uint16_t topic_req = uxr_buffer_create_topic_bin(&session, reliable_out, topic_id, participant_id,
+                    "StudentTopic",
+                    "Student", UXR_REPLACE);
+
+    uxrObjectId publisher_id = uxr_object_id(0x01, UXR_PUBLISHER_ID);
+    uint16_t publisher_req = uxr_buffer_create_publisher_bin(&session, reliable_out, publisher_id, participant_id,
+                    UXR_REPLACE);
+
+    uxrObjectId datawriter_id = uxr_object_id(0x01, UXR_DATAWRITER_ID);
+    uxrQoS_t qos = {
+        .reliability = UXR_RELIABILITY_RELIABLE, .durability = UXR_DURABILITY_TRANSIENT_LOCAL,
+        .history = UXR_HISTORY_KEEP_LAST, .depth = 0
+    };
+    uint16_t datawriter_req = uxr_buffer_create_datawriter_bin(&session, reliable_out, datawriter_id, publisher_id,
+                    topic_id, qos, UXR_REPLACE);
+
+    // Send create entities message and wait its status
+    uint8_t status[4];
+    uint16_t requests[4] = {
+        participant_req, topic_req, publisher_req, datawriter_req
+    };
+    if (!uxr_run_session_until_all_status(&session, 1000, requests, status, 4))
+    {
+        printf("Error at create entities: participant: %i topic: %i publisher: %i datawriter: %i\n", status[0],
+                status[1], status[2], status[3]);
+        return 1;
+    }
+
+    // Write topics
+    bool connected = true;
+    uint32_t count = 0;
+    while (connected && count < max_topics)
+    {
+        Student topic = {
+            "xiaomeixiang", 2021215222,"2003/05/08"
+        };
+
+        ucdrBuffer ub;
+        uint32_t topic_size = Student_size_of_topic(&topic, 0);
+        uxr_prepare_output_stream(&session, reliable_out, datawriter_id, &ub, topic_size);
+        Student_serialize_topic(&ub, &topic);
+
+        printf("Send topic: %s, id: %i,birthday %s\n", topic.name, topic.id,topic.birthday);
+        connected = uxr_run_session_time(&session, 1000);
+    }
+
+    // Delete resources
+    uxr_delete_session(&session);
+    uxr_close_udp_transport(&transport);
+
+    return 0;
+}
-- 
2.34.1

